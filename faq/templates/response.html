<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{user_query}}</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Arial, sans-serif;
        background-color: #1a1a1a;
        color: #e0e0e0;
        line-height: 1.5;
      }
      ::-moz-selection {
        /* Code for Firefox */
        color: #0a9bc9;
        background: #172426;
      }

      ::selection {
        color: #0a9bc9;
        background: #172426;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .header {
        padding-top: 10%;
      }

      .search-query {
        font-size: 24px;
        margin-bottom: 20px;
        color: #fff;
      }

      .nav-tabs {
        display: flex;
        gap: 20px;
        border-bottom: 1px solid #333;
      }

      .nav-tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
        color: #888;
        text-decoration: none;
        font-size: 14px;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
      }

      .nav-tab.active {
        color: #fff;
        border-bottom-color: #fff;
      }

      .nav-tab:hover {
        color: #ccc;
      }

      .source-title {
        font-size: 12px;
        color: #888;
        margin-bottom: 4px;
      }

      .main-content {
        gap: 30px;
        margin-bottom: 40px;
        margin-top: 25px;
      }

      .profile-card {
        /* background: #2a2a2a; */
        /* border-radius: 12px; */
        padding: 25px;
        /* border: 1px solid #333; */
        margin-bottom: 78px;
        margin-top: 15px;
      }

      .search-input-container {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 900px;
        z-index: 1000;
      }

      .search-input {
        width: 100%;
        padding: 15px 50px 15px 20px;
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 12px;
        color: #fff;
        font-size: 14px;
        outline: none;
        transition: all 0.2s ease;
      }

      .search-input:focus {
        border-color: #6db3f2;
        box-shadow: 0 0 0 2px rgba(109, 179, 242, 0.2);
      }

      .search-input::placeholder {
        color: #888;
      }

      @media (max-width: 768px) {
        .container {
          padding: 0 15px;
        }

        .search-query {
          font-size: 20px;
        }

        .nav-tabs {
          gap: 20px;
          overflow-x: auto;
          padding-bottom: 10px;
        }

        .main-content {
          grid-template-columns: 1fr;
          gap: 20px;
        }
      }

      @media (max-width: 480px) {
        .profile-card {
          padding: 20px;
        }

        .search-input-container {
          width: 95%;
        }
      }

      .profile-card li {
        list-style: inside;
        margin-bottom: 8px;
        /* padding-left: 25px; */
      }

      .profile-card ul {
        list-style: disc;
        padding-left: 25px;
      }

      .profile-card a {
        word-wrap: break-word;
      }

      h1 {
        font-size: 20px;
        line-height: 2.25rem;
      }
      /* display none for image and source div */
      .hidden {
        display: none;
      }

      .active-tab {
        display: block;
      }

      .profile-card a {
        color: #05bcf5;
      }

      textarea::-webkit-scrollbar {
      width: 10px;
      background: transparent;
      
      }

      textarea::-webkit-scrollbar-thumb {
      box-shadow: inset 0 0 5px grey;
      border-radius: 5px;
      cursor: pointer;
      }
      textarea::-webkit-scrollbar-thumb {
      background: grey;
      border-radius: 5px;
    }
    </style>
  </head>
  <body>
    <div class="container" style="max-width: 900px">
      <div class="header">
        <div id="query-container">
          <h1
            class="user-query change group/query relative whitespace-pre-line break-words [word-break:break-word] max-h-[144px] overflow-hidden font-display text-pretty text-xl lg:text-3xl font-[475] dark:font-[450] text-textMain dark:text-textMainDark selection:bg-super/50 selection:text-textMain dark:selection:bg-superDuper/10 dark:selection:text-superDark"
          >
            {{user_query}}
          </h1>
          <button
            class="toggle-button mt-2 text-sm text-blue-400 hover:underline"
            style="cursor: pointer"
          >
            See more
          </button>
        </div>

        <div class="nav-tabs">
          <a href="#" class="nav-tab active"
            ><svg
              style="width: 15px; height: 17px"
              width="60"
              height="74"
              viewBox="0 0 60 74"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              class="h-full w-auto shrink-0 transform-gpu"
            >
              <path
                d="M29.6848 25.4603L48.3092 41.4828V65.1065L29.6848 49.0293M29.6848 25.4603L10.5359 40.7925L10.5892 64.669L29.6316 49.0293M29.6848 25.4603L3.4071 24.8588V48.5542L10.0911 48.6959M29.6848 25.4603L55.9884 25.7611V49.5761L48.6649 49.4467M29.6848 25.4603L11.3722 9.03792L11.2884 24.5988M29.6848 25.4603L48.7956 9.74877V25.4474M29.6848 25.4603L29.63 2.75943M29.6848 25.4603V49.1113M29.63 71.6481L29.6848 49.0839"
                stroke="currentColor"
                stroke-width="4.7"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></path></svg>Answer</a
          >
          <a href="#" class="nav-tab"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.7142857142857142"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="tabler-icon tabler-icon-photo text-text-100 hidden duration-100 sm:block group-hover:opacity-100 opacity-80"
            >
              <path d="M15 8h.01"></path>
              <path
                d="M3 6a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v12a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3v-12z"
              ></path>
              <path d="M3 16l5 -5c.928 -.893 2.072 -.893 3 0l5 5"></path>
              <path d="M14 14l1 -1c.928 -.893 2.072 -.893 3 0l3 3"></path>
            </svg>
            Images</a
          >
          <a href="#" class="nav-tab"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              color="currentColor"
              class="text-text-100 hidden duration-100 sm:block group-hover:opacity-100 opacity-80"
              fill="currentColor"
              fill-rule="evenodd"
            >
              <path
                d="M12.2401 8.96004C10.6561 8.96004 9.36011 7.66404 9.36011 6.08004C9.36011 4.49604 10.6561 3.20004 12.2401 3.20004C13.8241 3.20004 15.1201 4.49604 15.1201 6.08004C15.1201 7.66404 13.8241 8.96004 12.2401 8.96004ZM12.2401 5.12004C11.7121 5.12004 11.2801 5.55204 11.2801 6.08004C11.2801 6.60804 11.7121 7.04004 12.2401 7.04004C12.7681 7.04004 13.2001 6.60804 13.2001 6.08004C13.2001 5.55204 12.7681 5.12004 12.2401 5.12004Z M18 14.7201C16.416 14.7201 15.12 13.4241 15.12 11.8401C15.12 10.2561 16.416 8.96011 18 8.96011C19.584 8.96011 20.88 10.2561 20.88 11.8401C20.88 13.4241 19.584 14.7201 18 14.7201ZM18 10.8801C17.472 10.8801 17.04 11.3121 17.04 11.8401C17.04 12.3681 17.472 12.8001 18 12.8001C18.528 12.8001 18.96 12.3681 18.96 11.8401C18.96 11.3121 18.528 10.8801 18 10.8801Z M6.48004 14.7201C4.89604 14.7201 3.60004 13.4241 3.60004 11.8401C3.60004 10.2561 4.89604 8.96011 6.48004 8.96011C8.06404 8.96011 9.36004 10.2561 9.36004 11.8401C9.36004 13.4241 8.06404 14.7201 6.48004 14.7201ZM6.48004 10.8801C5.95204 10.8801 5.52004 11.3121 5.52004 11.8401C5.52004 12.3681 5.95204 12.8001 6.48004 12.8001C7.00804 12.8001 7.44004 12.3681 7.44004 11.8401C7.44004 11.3121 7.00804 10.8801 6.48004 10.8801Z M12.2401 20.48C10.6561 20.48 9.36011 19.184 9.36011 17.6C9.36011 16.016 10.6561 14.72 12.2401 14.72C13.8241 14.72 15.1201 16.016 15.1201 17.6C15.1201 19.184 13.8241 20.48 12.2401 20.48ZM12.2401 16.64C11.7121 16.64 11.2801 17.072 11.2801 17.6C11.2801 18.128 11.7121 18.56 12.2401 18.56C12.7681 18.56 13.2001 18.128 13.2001 17.6C13.2001 17.072 12.7681 16.64 12.2401 16.64Z"
              ></path>
            </svg>
            Sources</a
          >
        </div>

        <div class="main-content">
          <div class="profile-card" style="display: none">
            {{bot_response|safe}}
          </div>
          <div class="tab-content tab-images hidden" style="display: none">
            this is image tab
          </div>
          <div class="tab-content tab-sources hidden" style="display: none">
            this is source tab
          </div>
        </div>
      </div>
      <div class="newDiv"></div>

      <form id="chat-form" class="chat-input">
        <div
          class="search-input-container container"
          style="display: flex; align-items: end; gap: 5px"
        >
          <textarea
  class="search-input w-full rounded-md text-sm px-3 py-2 leading-5 resize-none overflow-y-auto min-h-[40px] max-h-[290px]"
  rows="3"
  placeholder="Ask anything..."
></textarea>

          <button
            style="height: 47px; background: #0a9bc9;" 
            aria-label="Voice mode"
            type="submit"
            class="send-btn bg-super dark:bg-superDark dark:text-backgroundDark text-white hover:opacity-80 font-sans focus:outline-none outline-none outline-transparent transition duration-300 ease-out font-sans select-none items-center relative group/button justify-center text-center items-center rounded-lg cursor-pointer active:scale-[0.97] active:duration-150 active:ease-outExpo origin-center whitespace-nowrap inline-flex text-sm h-8 aspect-[9/8]"
            data-state="closed"
          >
            <div
              class="flex items-center min-w-0 font-medium gap-1.5 justify-center"
            >
              <div class="flex shrink-0 items-center justify-center size-4">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  color="currentColor"
                  fill="currentColor"
                  fill-rule="evenodd"
                >
                  <path
                    d="M0 12.6663C0 13.4018 0.59792 13.9997 1.33333 13.9997C2.06875 13.9997 2.66667 13.4018 2.66667 12.6663V11.333C2.66667 10.5975 2.06875 9.99967 1.33333 9.99967C0.59792 9.99967 0 10.5975 0 11.333V12.6663ZM6.66667 5.33301C7.40213 5.33301 8 5.93087 8 6.66634V17.333C8 18.0685 7.40213 18.6663 6.66667 18.6663C5.9312 18.6663 5.33333 18.0685 5.33333 17.333V6.66634C5.33333 5.93087 5.9312 5.33301 6.66667 5.33301ZM10.6667 21.333C10.6667 22.0685 11.2645 22.6663 12 22.6663C12.7355 22.6663 13.3333 22.0685 13.3333 21.333V2.66634C13.3333 1.93093 12.7355 1.33301 12 1.33301C11.2645 1.33301 10.6667 1.93093 10.6667 2.66634V21.333ZM17.3333 5.33301C18.0688 5.33301 18.6667 5.93087 18.6667 6.66634V17.333C18.6667 18.0685 18.0688 18.6663 17.3333 18.6663C16.5979 18.6663 16 18.0685 16 17.333V6.66634C16 5.93087 16.5979 5.33301 17.3333 5.33301ZM24 11.333C24 10.5975 23.4021 9.99967 22.6667 9.99967C21.9312 9.99967 21.3333 10.5975 21.3333 11.333V12.6663C21.3333 13.4018 21.9312 13.9997 22.6667 13.9997C23.4021 13.9997 24 13.4018 24 12.6663V11.333Z"
                  ></path>
                </svg>
              </div>
            </div>
          </button>
        </div>
      </form>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
   <script>
      $(document).ready(function () {
        // Apply see more logic to the static header (initial load)
        initSeeMoreToggle($(".header"));
        handleTabClicks($(".header"));
        // Form submit handler
        $("#chat-form").on("submit", function (e) {
          e.preventDefault();

          var query = $(".search-input").val().trim();
          if (!query) return;

          $(".search-input").val(""); // Clear input

          const safeQuery = escapeHtml(query);

          const conversationThread = $(`
        <div class="conversation-thread" style="margin-bottom: 2rem;">
          <div class="question-container">
            <h1 class="user-query max-h-[144px] overflow-hidden change group/query relative whitespace-pre-line break-words [word-break:break-word] font-display text-pretty text-xl lg:text-3xl font-[475] dark:font-[450] text-textMain dark:text-textMainDark selection:bg-super/50 selection:text-textMain dark:selection:bg-superDuper/10 dark:selection:text-superDark">
              ${safeQuery}
            </h1>
            <button class="toggle-button mt-2 text-sm text-blue-400 hover:underline">See more</button>

            <div class="nav-tabs">
              <a href="#" class="nav-tab active"
            ><svg
              style="width: 15px; height: 17px"
              width="60"
              height="74"
              viewBox="0 0 60 74"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              class="h-full w-auto shrink-0 transform-gpu"
            >
              <path
                d="M29.6848 25.4603L48.3092 41.4828V65.1065L29.6848 49.0293M29.6848 25.4603L10.5359 40.7925L10.5892 64.669L29.6316 49.0293M29.6848 25.4603L3.4071 24.8588V48.5542L10.0911 48.6959M29.6848 25.4603L55.9884 25.7611V49.5761L48.6649 49.4467M29.6848 25.4603L11.3722 9.03792L11.2884 24.5988M29.6848 25.4603L48.7956 9.74877V25.4474M29.6848 25.4603L29.63 2.75943M29.6848 25.4603V49.1113M29.63 71.6481L29.6848 49.0839"
                stroke="currentColor"
                stroke-width="4.7"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></path></svg>Answer</a
          >
              <a href="#" class="nav-tab"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.7142857142857142"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="tabler-icon tabler-icon-photo text-text-100 hidden duration-100 sm:block group-hover:opacity-100 opacity-80"
            >
              <path d="M15 8h.01"></path>
              <path
                d="M3 6a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v12a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3v-12z"
              ></path>
              <path d="M3 16l5 -5c.928 -.893 2.072 -.893 3 0l5 5"></path>
              <path d="M14 14l1 -1c.928 -.893 2.072 -.893 3 0l3 3"></path>
            </svg>
            Images</a
          >
              <a href="#" class="nav-tab"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              color="currentColor"
              class="text-text-100 hidden duration-100 sm:block group-hover:opacity-100 opacity-80"
              fill="currentColor"
              fill-rule="evenodd"
            >
              <path
                d="M12.2401 8.96004C10.6561 8.96004 9.36011 7.66404 9.36011 6.08004C9.36011 4.49604 10.6561 3.20004 12.2401 3.20004C13.8241 3.20004 15.1201 4.49604 15.1201 6.08004C15.1201 7.66404 13.8241 8.96004 12.2401 8.96004ZM12.2401 5.12004C11.7121 5.12004 11.2801 5.55204 11.2801 6.08004C11.2801 6.60804 11.7121 7.04004 12.2401 7.04004C12.7681 7.04004 13.2001 6.60804 13.2001 6.08004C13.2001 5.55204 12.7681 5.12004 12.2401 5.12004Z M18 14.7201C16.416 14.7201 15.12 13.4241 15.12 11.8401C15.12 10.2561 16.416 8.96011 18 8.96011C19.584 8.96011 20.88 10.2561 20.88 11.8401C20.88 13.4241 19.584 14.7201 18 14.7201ZM18 10.8801C17.472 10.8801 17.04 11.3121 17.04 11.8401C17.04 12.3681 17.472 12.8001 18 12.8001C18.528 12.8001 18.96 12.3681 18.96 11.8401C18.96 11.3121 18.528 10.8801 18 10.8801Z M6.48004 14.7201C4.89604 14.7201 3.60004 13.4241 3.60004 11.8401C3.60004 10.2561 4.89604 8.96011 6.48004 8.96011C8.06404 8.96011 9.36004 10.2561 9.36004 11.8401C9.36004 13.4241 8.06404 14.7201 6.48004 14.7201ZM6.48004 10.8801C5.95204 10.8801 5.52004 11.3121 5.52004 11.8401C5.52004 12.3681 5.95204 12.8001 6.48004 12.8001C7.00804 12.8001 7.44004 12.3681 7.44004 11.8401C7.44004 11.3121 7.00804 10.8801 6.48004 10.8801Z M12.2401 20.48C10.6561 20.48 9.36011 19.184 9.36011 17.6C9.36011 16.016 10.6561 14.72 12.2401 14.72C13.8241 14.72 15.1201 16.016 15.1201 17.6C15.1201 19.184 13.8241 20.48 12.2401 20.48ZM12.2401 16.64C11.7121 16.64 11.2801 17.072 11.2801 17.6C11.2801 18.128 11.7121 18.56 12.2401 18.56C12.7681 18.56 13.2001 18.128 13.2001 17.6C13.2001 17.072 12.7681 16.64 12.2401 16.64Z"
              ></path>
            </svg>
            Sources</a
          >
            </div>
          </div>
          <div class="response-container">
            <div class="profile-card loading">Searching...</div>
            <div class="tab-content tab-images hidden" style="display: none;">${safeQuery}</div>
            <div class="tab-content tab-sources hidden" style="display: none;">${safeQuery}</div>
          </div>
        </div>
      `);

          $(".newDiv").append(conversationThread);

          initSeeMoreToggle(conversationThread);
          handleTabClicks(conversationThread);

          $("html, body").animate(
            {
              scrollTop: conversationThread.offset().top - 100,
            },
            500
          );

          fetch("/chatbot-api/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ query: query }),
          })
            .then((response) => {
              const reader = response.body.getReader();
              const decoder = new TextDecoder();
              const responsediv = conversationThread.find(".profile-card");
              responsediv.empty(); // clear "Searching..."

              function read() {
                reader.read().then(({ done, value }) => {
                  if (done) return;

                  const chunk = decoder.decode(value, { stream: true });
                  console.log("Received chunk:", chunk); // Debug log

                  responsediv.append(marked.parse(chunk)); // Append chunk safely
                  read(); // Keep reading next chunk
                });
              }

              read();
            })
            .catch((error) => {
              console.error("Streaming error:", error);
              conversationThread
                .find(".profile-card")
                .html(
                  `<span style="color:red;">Error: ${error.message}</span>`
                );
            });
        });

        // Tab click handler
        function handleTabClicks(container) {
          container
            .find(".nav-tab")
            .off("click")
            .on("click", function (e) {
              e.preventDefault();
              const clickedTab = $(this);
              const thread = clickedTab.closest(
                ".conversation-thread, .header"
              );

              thread.find(".nav-tab").removeClass("active");
              clickedTab.addClass("active");

              thread.find(".profile-card, .tab-images, .tab-sources").hide();

              const index = thread.find(".nav-tab").index(clickedTab);
              if (index === 0) thread.find(".profile-card").show();
              else if (index === 1) thread.find(".tab-images").show();
              else if (index === 2) thread.find(".tab-sources").show();
            });

          container.find(".nav-tab.active").trigger("click");
        }

        // See more toggle handler
        function initSeeMoreToggle(container) {
          const queryElement = container.find(".user-query")[0];
          const toggleButton = container.find(".toggle-button")[0];

          if (!queryElement || !toggleButton) return;

          setTimeout(() => {
            if (queryElement.scrollHeight > queryElement.clientHeight) {
              toggleButton.style.display = "inline-block";
            } else {
              toggleButton.style.display = "none";
            }

            // Prevent multiple listeners
            $(toggleButton)
              .off("click")
              .on("click", function () {
                const isCollapsed =
                  queryElement.classList.contains("max-h-[144px]");
                if (isCollapsed) {
                  queryElement.classList.remove(
                    "max-h-[144px]",
                    "overflow-hidden"
                  );
                  toggleButton.textContent = "Show less";
                } else {
                  queryElement.classList.add(
                    "max-h-[144px]",
                    "overflow-hidden"
                  );
                  toggleButton.textContent = "See more";
                }
              });
          }, 30);
        }

        // Escape HTML to prevent XSS or rendering issues
        function escapeHtml(text) {
          return $("<div>").text(text).html();
        }

        // Search input UI feedback
        const searchInput = document.querySelector(".search-input");
        searchInput.addEventListener("focus", function () {
          this.style.background = "#333";
        });
        searchInput.addEventListener("blur", function () {
          this.style.background = "#2a2a2a";
        });
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const textarea = document.querySelector(".search-input");

        textarea.addEventListener("input", () => {
          textarea.style.height = "auto"; // Reset height
          textarea.style.height = `${textarea.scrollHeight}px`; // Set new height
        });
      });
    </script>


    <!-- <script>
      $(document).ready(function () {
        // Handle tab clicks for the initial conversation (if exists)
        initSeeMoreToggle($(".header"));
        handleTabClicks($(".header"));

        $("#chat-form").on("submit", function (e) {
          e.preventDefault(); // Prevent the form from reloading the page

          var query = $(".search-input").val().trim();
          if (!query) return;

          // Clear the input
          $(".search-input").val("");

          // Create a new conversation thread container
          const conversationThread = $(`
      <div class="conversation-thread" style="margin-bottom: 2rem;">
        <div class="question-container">
          <h1 class="user-query change group/query relative whitespace-pre-line break-words [word-break:break-word] max-h-[144px] font-display text-pretty text-xl lg:text-3xl font-[475] dark:font-[450] text-textMain dark:text-textMainDark selection:bg-super/50 selection:text-textMain dark:selection:bg-superDuper/10 dark:selection:text-superDark overflow-hidden">
            ${query}
          </h1>
          <button class="toggle-button mt-2 text-sm text-blue-400 hover:underline ">See more</button>

          <div class="nav-tabs">
            <a href="#" class="nav-tab active">
              <svg style="width: 15px; height: 17px" width="60" height="74" viewBox="0 0 60 74" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-full w-auto shrink-0 transform-gpu">
                <path d="M29.6848 25.4603L48.3092 41.4828V65.1065L29.6848 49.0293M29.6848 25.4603L10.5359 40.7925L10.5892 64.669L29.6316 49.0293M29.6848 25.4603L3.4071 24.8588V48.5542L10.0911 48.6959M29.6848 25.4603L55.9884 25.7611V49.5761L48.6649 49.4467M29.6848 25.4603L11.3722 9.03792L11.2884 24.5988M29.6848 25.4603L48.7956 9.74877V25.4474M29.6848 25.4603L29.63 2.75943M29.6848 25.4603V49.1113M29.63 71.6481L29.6848 49.0839" stroke="currentColor" stroke-width="4.7" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>Answer
            </a>
            <a href="#" class="nav-tab">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7142857142857142" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-photo text-text-100 hidden duration-100 sm:block group-hover:opacity-100 opacity-80">
                <path d="M15 8h.01"></path>
                <path d="M3 6a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v12a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3v-12z"></path>
                <path d="M3 16l5 -5c.928 -.893 2.072 -.893 3 0l5 5"></path>
                <path d="M14 14l1 -1c.928 -.893 2.072 -.893 3 0l3 3"></path>
              </svg>Images
            </a>
            <a href="#" class="nav-tab">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" color="currentColor" class="text-text-100 hidden duration-100 sm:block group-hover:opacity-100 opacity-80" fill="currentColor" fill-rule="evenodd">
                <path d="M12.2401 8.96004C10.6561 8.96004 9.36011 7.66404 9.36011 6.08004C9.36011 4.49604 10.6561 3.20004 12.2401 3.20004C13.8241 3.20004 15.1201 4.49604 15.1201 6.08004C15.1201 7.66404 13.8241 8.96004 12.2401 8.96004ZM12.2401 5.12004C11.7121 5.12004 11.2801 5.55204 11.2801 6.08004C11.2801 6.60804 11.7121 7.04004 12.2401 7.04004C12.7681 7.04004 13.2001 6.60804 13.2001 6.08004C13.2001 5.55204 12.7681 5.12004 12.2401 5.12004Z M18 14.7201C16.416 14.7201 15.12 13.4241 15.12 11.8401C15.12 10.2561 16.416 8.96011 18 8.96011C19.584 8.96011 20.88 10.2561 20.88 11.8401C20.88 13.4241 19.584 14.7201 18 14.7201ZM18 10.8801C17.472 10.8801 17.04 11.3121 17.04 11.8401C17.04 12.3681 17.472 12.8001 18 12.8001C18.528 12.8001 18.96 12.3681 18.96 11.8401C18.96 11.3121 18.528 10.8801 18 10.8801Z M6.48004 14.7201C4.89604 14.7201 3.60004 13.4241 3.60004 11.8401C3.60004 10.2561 4.89604 8.96011 6.48004 8.96011C8.06404 8.96011 9.36004 10.2561 9.36004 11.8401C9.36004 13.4241 8.06404 14.7201 6.48004 14.7201ZM6.48004 10.8801C5.95204 10.8801 5.52004 11.3121 5.52004 11.8401C5.52004 12.3681 5.95204 12.8001 6.48004 12.8001C7.00804 12.8001 7.44004 12.3681 7.44004 11.8401C7.44004 11.3121 7.00804 10.8801 6.48004 10.8801Z M12.2401 20.48C10.6561 20.48 9.36011 19.184 9.36011 17.6C9.36011 16.016 10.6561 14.72 12.2401 14.72C13.8241 14.72 15.1201 16.016 15.1201 17.6C15.1201 19.184 13.8241 20.48 12.2401 20.48ZM12.2401 16.64C11.7121 16.64 11.2801 17.072 11.2801 17.6C11.2801 18.128 11.7121 18.56 12.2401 18.56C12.7681 18.56 13.2001 18.128 13.2001 17.6C13.2001 17.072 12.7681 16.64 12.2401 16.64Z"></path>
              </svg>Sources
            </a>
          </div>
        </div>
        <div class="response-container">
          <div class="profile-card loading">Searching...</div>
          <div class="tab-content tab-images hidden" style="display: none;">${query}</div>
          <div class="tab-content tab-sources hidden" style="display: none;">${query}</div>
        </div>
      </div>
    `);

          // Append the new conversation thread to main-content
          $(".newDiv").append(conversationThread);
          initSeeMoreToggle(conversationThread);
          // Set up tab functionality for this specific conversation thread
          handleTabClicks(conversationThread);

          // Scroll to the new question
          $("html, body").animate(
            {
              scrollTop: conversationThread.offset().top - 100,
            },
            500
          );

          $.ajax({
            type: "POST",
            url: "/chatbot-api/",
            contentType: "application/json",
            data: JSON.stringify({ query: query }),
            success: function (response) {
              if (response.status) {
                // Update the response in the current conversation thread
                conversationThread
                  .find(".response-container .profile-card")
                  .removeClass("loading")
                  .html(response.response);
              } else {
                conversationThread
                  .find(".response-container .profile-card")
                  .removeClass("loading")
                  .addClass("text-red-500")
                  .html("Error: " + response.error);
              }
            },
            error: function (xhr, status, error) {
              console.error("AJAX error:", error);
              conversationThread
                .find(".response-container .profile-card")
                .removeClass("loading")
                .addClass("text-red-500")
                .html("Ajax error: " + error);
            },
          });
        });

        // Function to handle tab clicks for a specific conversation thread
        function handleTabClicks(container) {
          container
            .find(".nav-tab")
            .off("click")
            .on("click", function (e) {
              e.preventDefault();

              const clickedTab = $(this);
              const conversationContainer = clickedTab.closest(
                ".conversation-thread, .header"
              );

              // Remove 'active' class from all nav tabs in this conversation
              conversationContainer.find(".nav-tab").removeClass("active");

              // Add 'active' class to clicked tab
              clickedTab.addClass("active");

              // Hide all content in this conversation
              conversationContainer
                .find(".profile-card, .tab-images, .tab-sources")
                .hide();

              // Show the appropriate content based on tab index
              const tabIndex = conversationContainer
                .find(".nav-tab")
                .index(clickedTab);

              if (tabIndex === 0) {
                // Answer tab
                conversationContainer.find(".profile-card").show();
              } else if (tabIndex === 1) {
                // Images tab
                conversationContainer.find(".tab-images").show();
              } else if (tabIndex === 2) {
                // Sources tab
                conversationContainer.find(".tab-sources").show();
              }
            });

          // Show the default active tab for this conversation
          container.find(".nav-tab.active").trigger("click");
        }
      });
    </script>

    <script>
      // Search input focus effect
      const searchInput = document.querySelector(".search-input");
      searchInput.addEventListener("focus", function () {
        this.style.background = "#333";
      });

      searchInput.addEventListener("blur", function () {
        this.style.background = "#2a2a2a";
      });
    </script>
    <script>
  function initSeeMoreToggle(container) {
  const queryElement = container.find(".user-query")[0];
  const toggleButton = container.find(".toggle-button")[0];

  if (!queryElement || !toggleButton) return;

  // Delay to ensure the element is rendered and sized
  setTimeout(() => {
    if (queryElement.scrollHeight > queryElement.clientHeight) {
      toggleButton.style.display = "inline-block";
    } else {
      toggleButton.style.display = "none";
    }

    toggleButton.addEventListener("click", () => {
      const isCollapsed = queryElement.classList.contains("max-h-[144px]");
      if (isCollapsed) {
        queryElement.classList.remove("max-h-[144px]", "overflow-hidden");
        toggleButton.textContent = "Show less";
      } else {
        queryElement.classList.add("max-h-[144px]", "overflow-hidden");
        toggleButton.textContent = "See more";
      }
    });
  }, 30); // 30ms is typically enough for layout to settle
}
</script> -->
  </body>
</html>
